
#Область _// Работа с реквизитами формы

Процедура НайтиСоздатьРеквизитФормыТаблица(Форма, ИмяТаблицы)
	
	Буфер = Новый Структура(ИмяТаблицы);
	ЗаполнитьЗначенияСвойств(Буфер, Форма);
	Если НЕ Буфер[ИмяТаблицы] = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ДобавляемыеРеквизиты = Новый Массив;
	Реквизит = Новый РеквизитФормы(ИмяТаблицы, Новый ОписаниеТипов("ТаблицаЗначений"));
	ДобавляемыеРеквизиты.Добавить(Реквизит);
	Форма.ИзменитьРеквизиты(ДобавляемыеРеквизиты);	
	
КонецПроцедуры

Процедура ОбновитьКолонкиТаблицыРеквизита(Форма, ИмяТаблицы, ТаблицаЗначений)
	
	НеудаляемыеРеквизиты = Новый Массив;
	
	Реквизиты = Форма.ПолучитьРеквизиты(ИмяТаблицы);
	Для каждого Реквизит из Реквизиты Цикл
	    УдаляемыеРеквизиты = Новый Массив;
		УдаляемыеРеквизиты.Добавить(ИмяТаблицы + "." + Реквизит.Имя);
		Попытка
			Форма.ИзменитьРеквизиты( ,УдаляемыеРеквизиты);	
		Исключение
			НеудаляемыеРеквизиты.Добавить(Реквизит.Имя);
		КонецПопытки;
	КонецЦикла;
	
	
	Реквизиты = Форма.ПолучитьРеквизиты(ИмяТаблицы);
	ДобавляемыеРеквизиты = Новый Массив;
	Для каждого Колонка из ТаблицаЗначений.Колонки Цикл
		Если НЕ НеудаляемыеРеквизиты.Найти(Колонка.Имя) = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
        Реквизит = Новый РеквизитФормы(Колонка.Имя, Колонка.ТипЗначения, ИмяТаблицы, Колонка.Заголовок);
		ДобавляемыеРеквизиты.Добавить(Реквизит);
	КонецЦикла;
	Форма.ИзменитьРеквизиты(ДобавляемыеРеквизиты);	
	
КонецПроцедуры

#КонецОбласти

#Область _// Работа с элементами формы

Процедура НайтиСоздатьТабличноеПолеНаФорме(Форма, ИмяТаблицы)
	
	Если не Форма.Элементы.Найти(ИмяТаблицы) = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТаблицаФормы = Форма.Элементы.Добавить(ИмяТаблицы, Тип("ТаблицаФормы"));
	ТаблицаФормы.ПутьКДанным = ИмяТаблицы;
		
КонецПроцедуры

Процедура ОбновитьКолонкиТабличногоПоля(Форма, ИмяТаблицы)
	
	ТаблицаНаФорме = Форма.Элементы[ИмяТаблицы];
	КоллекцияКолонок = ТаблицаНаФорме.ПодчиненныеЭлементы;
	
	НеудаляемыеЭлементыФормы = Новый Массив; // если колонка добавлена в режиме конфигурирования, то ее нельзя удалить
	
	// 1. Удалить колонки
	КоличествоКолонок = КоллекцияКолонок.Количество() - 1;
	Для сч = -КоличествоКолонок по 0 Цикл
		Колонка = КоллекцияКолонок.Получить(-сч);
		Попытка
			Форма.Элементы.Удалить(Колонка);
		Исключение
			НеудаляемыеЭлементыФормы.Добавить(Колонка.ПутьКДанным);
		КонецПопытки;
	КонецЦикла;
	
	// 2. Создать колонки
	ТаблицаИсточник = Вычислить("Форма."+ТаблицаНаФорме.ПутьКДанным).Выгрузить();
	Для каждого Колонка из ТаблицаИсточник.Колонки Цикл
		ИмяКолонкиФормы = ТаблицаНаФорме.Имя + "_" + Колонка.Имя;
		Если НЕ КоллекцияКолонок.Найти(ИмяКолонкиФормы) = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		ПутьКДанным = ТаблицаНаФорме.ПутьКДанным+"."+Колонка.Имя;
		Если НЕ НеудаляемыеЭлементыФормы.Найти(ПутьКДанным) = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		КолонкаНаФорме = Форма.Элементы.Добавить(ИмяКолонкиФормы, Тип("ПолеФормы"), ТаблицаНаФорме);
		КолонкаНаФорме.Вид = ВидПоляФормы.ПолеВвода;
		КолонкаНаФорме.ПутьКДанным = ПутьКДанным;
		
	КонецЦикла;
	
	
КонецПроцедуры

#КонецОбласти


Процедура ОбновитьТаблицуНаФормеПоТаблицеЗначений(Форма, ИмяТаблицы, ТаблицаЗначений) Экспорт
	
	НайтиСоздатьРеквизитФормыТаблица(Форма, ИмяТаблицы);
	
	ОбновитьКолонкиТаблицыРеквизита(Форма, ИмяТаблицы, ТаблицаЗначений);
	
	Форма[ИмяТаблицы].Загрузить(ТаблицаЗначений);
	
	НайтиСоздатьТабличноеПолеНаФорме(Форма, ИмяТаблицы);
	
	ОбновитьКолонкиТабличногоПоля(Форма, ИмяТаблицы);
	
КонецПроцедуры

